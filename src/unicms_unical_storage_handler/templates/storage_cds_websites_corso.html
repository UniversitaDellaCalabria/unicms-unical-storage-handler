{% extends "pages/unical_cds_website.html" %}

{% load static %}
{% load i18n %}

{% load unicms_contexts %}
{% load unicms_storage_handler %}
{% load unicms_templates %}

{% include "includes/unical_storage_loading.html" %}


<!-- SEO  -->
{% block page_title %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_CORSO_LABEL" as page_title %}
{{ page_title }} - {{ block.super }}
{% endblock page_title %}


{% block container %}


{% get_cds_website_webpath webpath.pk as cds_identifier %}
{% get_current_language as LANGUAGE_CODE %}
{% breadcrumbs webpath=webpath leaf=handler %}

{% get_allowed_website request.get_host as host %}
{% settings_value "CMS_PATH_PREFIX" as cms_path_prefix %}
{% storage_settings_value "CMS_STORAGE_BASE_PATH" as base_prefix %}
{% storage_settings_value "CMS_STORAGE_CDS_VIEW_PREFIX_PATH" as cds_prefix %}
{% storage_settings_value "CMS_STORAGE_ACTIVITY_VIEW_PREFIX_PATH" as activity_prefix %}
{% storage_settings_value "CMS_STORAGE_BASE_API" as base_api %}
{% storage_settings_value "CMS_STORAGE_CDS_API" as cds_api %}
{% storage_settings_value "CDS_WEBSITE_COURSE_INFO_FIELDS" as fields_to_show %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_TOPICS_API" as topics_api %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_PAGE_TOPICS" as page_topics %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_TOPIC_ARTICLES_API" as page_topic_articles %}
{% storage_api_root "CMS_STORAGE_ACADEMICYEARS_API" as academicyears_api %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_CORSO_LABEL" as page_title %}
{% storage_settings_value "MAIN_DOMAIN" as unicms_root_url %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_API" as cds_websites_api %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDYPLANS_API" as cds_websites_studyplans_api %}
{% storage_settings_value "EXCLUDE_STUDY_ACTIVITIES_CODES" as exclude_studyactivity_codes %}
{% storage_settings_value "CDS_EXCLUDE_YEAR" as cds_exclude_year %}
{% storage_settings_value "CURRENT_YEAR" as current_year %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_BASE_PATH" as cds_base_path %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_VIEW_PREFIX_PATH" as cds_studiare_path %}

{% include "includes/unical_storage_loading.html" %}



<div class="col-12 py-5 bd-content">
    <div>
        {% block centered_container %}
        <div class="container">
            <div class="row">
                <div class="col-12 col-lg-8">
                    <p class="h1 lighter">{{ page_title }}</p>
                    <div class="mt-5" id="_{{ cds_cod }}_1">
                        <p>[[ item.CDSIntro ]]</p>
                    </div>

                    <div class="mt-5" id="_{{ cds_cod }}">

<!--
                        <hr />
-->

                        <loading-icon
                            v-if="_cds_data.is_loading"
                            :loader_source="loader_source">
                        </loading-icon>

                        <div v-else>

                            {% comment %}
                            <p class="h3 lighter">
                                [[ _cds_data.fixed_cds.CourseTypeDescription ]] <span v-if="_cds_data.fixed_cds.CourseInterClassCod">{% trans "interclass" %}</span>
                            </p>
                            <p class="h3">
                                [[ _cds_data.fixed_cds.CdSName ]]
                            </p>
                            <p class="h5 lighter">
                                [[ _cds_data.fixed_cds.CourseClassCod ]] / [[ _cds_data.fixed_cds.CourseClassName ]]
                            </p>
                            <p class="h5 lighter" v-if="_cds_data.fixed_cds.CourseInterClassCod">
                                [[ _cds_data.fixed_cds.CourseInterClassCod ]] / [[ _cds_data.fixed_cds.CourseInterClassDes ]]
                            </p>


<!--
                            <p class="h5 lighter mt-4">
                                {% trans "Referral Department" %}
                            </p>
-->
                            <p class="h5 mt-4">
                                <b>[[ _cds_data.fixed_cds.DepartmentName ]]</b>
                            </p>

                            <p class="h5 lighter mt-4">
                                {% trans "Language" %}
                            </p>
                            <p class="h5">
                                <b v-for="(lang, index) in _cds_data.fixed_cds.CdSLanguage">
                                    <span v-if="index > 0">, </span>
                                    [[ lang ]]
                                </b>
                            </p>
                            {% endcomment %}

                            <div class="row">
                                <div class="col-sm form-group mb-0">
                                    <label for="academic_year_input">
                                        {% trans "Year of registration" %}
                                    </label>
                                    <div class="w-30 mt-5">
                                        <select id="academic_year_input"
                                                title="{% trans 'Choose an option' %}"
                                                name="academic_year_input"
                                                class="form-control"
                                                 @change="changeYear($event.target.value)">
                                          <option v-for="item in academic_years_filter"
                                                  :value="item.AcademicYear"
                                                  v-if="item.AcademicYear != '{{ cds_exclude_year }}'"
                                                  :selected="item.AcademicYear == _cds_data.cds.AcademicYear">
                                              [[ item.AcademicYear ]]/[[ item.AcademicYear + 1 ]]
                                          </option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-5">
                                <div id="accordionDiv1-lft" class="accordion accordion-left-icon">
                                    <div v-for="name in fields_to_show" v-if="_cds_data.cds[name] && (_cds_data.cds[name].length > 0 || Object.keys(_cds_data.cds[name]).length > 0) && name != 'CdSSatisfactionSurvey'">
                                        <div class="accordion-item">
                                            <div class="accordion-header" :id="'heading-' + name +'-lft'">
                                                <button class="accordion-button"
                                                        type="button"
                                                        data-bs-toggle="collapse"
                                                        :data-bs-target="'#collapse-' + name +'-lft'"
                                                        aria-expanded="false"
                                                        :aria-controls="'collapse-' + name +'-lft'">
                                                    [[ _cds_data.cds_labels[name] ]]
                                                </button>
                                            </div>
                                            <div :id="'collapse-' + name +'-lft'"
                                                 class="accordion-collapse collapse"
                                                 data-bs-parent="#accordionDiv1-lft"
                                                 role="region"
                                                 :aria-labelledby="'heading-' + name +'-lft'">
                                                <div class="accordion-body">
                                                    <span v-if="Array.isArray(_cds_data.cds[name])">
                                                        <ul>
                                                            <li v-for="subvalue in _cds_data.cds[name]">
                                                                <span v-if="_cds_data.containsHTML(subvalue)" v-html="subvalue"></span>
                                                                <span v-else>[[ subvalue ]]</span>
                                                            </li>
                                                        </ul>
                                                    </span>
                                                    <span v-else-if="typeof _cds_data.cds[name] === 'object'">
                                                        <ul v-for="(valueProfile, nameProfile) in _cds_data.cds[name]">
                                                            <li>
                                                                [[ nameProfile ]]
                                                                <ul v-for="(valueProfileInstance, nameProfileInstance) in valueProfile">
                                                                    <li>
                                                                        <span v-if="nameProfileInstance in _cds_data.cds_labels"
                                                                              style="white-space: pre-line;">
                                                                            [[ _cds_data.cds_labels[nameProfileInstance] ]]
                                                                        </span>
                                                                        <span v-else>
                                                                            [[ nameProfileInstance ]]
                                                                        </span> :
                                                                        <span v-if="_cds_data.containsHTML(valueProfileInstance)" v-html="valueProfileInstance"></span>
                                                                        <span v-else style="white-space: pre-line;">[[ valueProfileInstance ]]</span>
                                                                    </li>
                                                                </ul>
                                                            </li>
                                                        </ul>
                                                    </span>
                                                    <span v-else>
                                                        <span style="white-space: pre-line;">
                                                            {% if full_page %}
                                                            <a v-if="name != 'CdSSatisfactionSurvey' && name == 'CdSDoc'" v-bind:href="_cds_data.cds[name]">
                                                                [[ _cds_data.cds[name] ]]
                                                            </a>
                                                            <span v-else-if="name != 'CdSSatisfactionSurvey'">
                                                                <span v-if="_cds_data.containsHTML(_cds_data.cds[name])" v-html="_cds_data.cds[name]"></span>
                                                                <span v-else>[[ _cds_data.cds[name] ]]</span>
                                                            </span>
                                                            {% else %}
                                                            <a v-if="name == 'CdSSatisfactionSurvey'" v-bind:href="'{{ almalaurea_link }}' + _cds_data.cds[name]">
                                                                {{ almalaurea_link }}[[ _cds_data.cds[name] ]]
                                                            </a>
                                                            <a v-else-if="name == 'CdSDoc'" v-bind:href="_cds_data.cds[name]">
                                                                [[ _cds_data.cds[name] ]]
                                                            </a>
                                                            <span v-else>
                                                                <span v-if="_cds_data.containsHTML(_cds_data.cds[name])" v-html="_cds_data.cds[name]"></span>
                                                                <span v-else>[[ _cds_data.cds[name] ]]</span>
                                                            </span>
                                                            {% endif %}
                                                        </span>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- study plans new -->
                    <div id="course_studyplans" class="mt-5">
                        <loading-icon
                            v-if="is_loading"
                            :loader_source="loader_source">
                        </loading-icon>
                        <div v-else-if="items && 'PlanTabs' in items">
                            <p class="h4 lighter mb-3">{% trans "Study plan" %}</p>

                            <div v-if="curricula.length == 1">

                                <div id="accordionDiv00-lft" class="accordion accordion-left-icon">
                                    <div class="accordion-item" v-for="tab in items.PlanTabs">
                                        {% include "includes/unical_storage_cds_website_studyplan_accordion.html" %}
                                    </div>
                                </div>
                            </div>
                            <div v-else>
                                <div id="accordionDiv000-lft" class="accordion accordion-left-icon">
                                    <div class="accordion-item" v-for="(curriculum, index1) in curricula">
                                        <div class="accordion-header" :id="'heading-cdswebsitestudyplan-' + index1 + '-lft'">
                                            <button class="accordion-button"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    :data-bs-target="'#collapse-cdswebsitestudyplan-' + index1 + '-lft'"
                                                    aria-expanded="false"
                                                    :aria-controls="'collapse-cdswebsitestudyplan-' + index1 + '-lft'">
                                                [[ curriculum ]]
                                            </button>
                                        </div>
                                        <div :id="'collapse-cdswebsitestudyplan-' + index1 + '-lft'"
                                             class="accordion-collapse collapse"
                                             data-bs-parent="#accordionDiv000-lft"
                                             role="region"
                                             :aria-labelledby="'heading-cdswebsitestudyplan-' + index1 + '-lft'">
                                            <div class="accordion-body mt-3">
                                                <div id="accordionDiv00-lft" class="accordion accordion-left-icon">
                                                    <div class="accordion-item" v-for="tab in items.PlanTabs" v-if="tab.PdsDes == curriculum">
                                                        {% include "includes/unical_storage_cds_website_studyplan_accordion.html" %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info mt-4" role="alert">
                                <p><b>{% trans "What does it mean?" %}</b></p>
                                <hr>
                                <ul>
                                    <li>
                                        <b>Piano di studio Statutario:</b>
                                        è il piano ufficiale che il corso di studio attribuisce
                                        automaticamente a tutti gli studenti immatricolati.
                                        Nella prima modifica del piano di studio lo studente può variare
                                        le attività all'interno di eventuali gruppi di materie opzionali
                                        e indicare le scelte libere
                                    </li>
                                    <li>
                                        <b>Piano di studio Alternativo:</b>
                                        è il piano che lo studente presenta scegliendo le attività
                                        formative all’interno di opzioni e scelte libere,
                                        predisposte dal corso di studio, nel rispetto di alcuni vincoli
                                    </li>
                                    <li>
                                        <b>Piano di studio Part-time:</b>
                                        è il percorso dello studente che ha optato per il regime di tempo parziale,
                                        tipicamente con la metà del numero di crediti formativi per anno rispetto al tempo pieno
                                    </li>
                                    <li>
                                        <b>Attività a scelta:</b>
                                        lo studente potrà scegliere tra attività offerte dai corsi di studio dell'ateneo
                                        (scelta <i>"libera da OF"</i>) oppure all'interno di elenchi predefiniti dal corso di studio,
                                        secondo le regole indicate nella piattaforma web di modifica del piano.
                                    </li>
                                    <li>
                                        <b>Vincoli:</b>
                                        esprimono il numero minimo/massimo di crediti formativi da scegliere
                                        all’interno di un gruppo di insegnamenti e/o di tipologia di corsi di studio.
                                    </li>
                                    <li>
                                        <b>Modifica del piano di studio:</b>
                                        lo studente può modificare il piano di studio prima dell’inizio di ogni semestre,
                                        nella relativa finestra temporale stabilita dal Dipartimento.
                                        Seguire le indicazioni nella pagina
                                        "<a href="{{ webpath.fullpath }}{{ cds_base_path }}/{{ cds_studiare_path }}/">Studiare</a>" del sito.
                                        Per maggiori dettagli, consultare il
                                        <a :href="_cds_data.fixed_cds.DidacticRegulation" target="_blank">Regolamento didattico</a> del corso
                                        e il <a :href="_cds_data.fixed_cds.StudyManifesto" target="_blank">Manifesto degli studi</a>.
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-3 offset-lg-1 mt-4 mt-lg-0">
                    {% include "includes/unical_storage_cds_website_right_static.html" %}
                    <hr style="color: transparent" class="my-3" />
                    {% include "includes/unical_storage_cds_website_right_contacts.html" %}
                    <hr style="color: transparent" class="my-3" />
                    {% include "includes/unical_storage_cds_website_right_links.html" with hide_ordinamento=1 %}

                    <div id="_cds_website_right_col_dynamic" class="mt-4">
                        <div v-if="_cds_data.cds.StudyManifesto || _cds_data.cds.DidacticRegulation || _cds_data.cds.TeachingSystem">
                            <div class="background-light-grey px-2 py-3 mb-2 w-100">
                                <div class="row">
                                    <div class="col-2">
                                        <b>
                                            <svg class="icon" aria-labelledby="info_menu">
                                                <title id="doc_menu">{% trans "Documents" %}</title>
                                                <use xlink:href="{% static 'svg/sprites.svg' %}#it-files"></use>
                                            </svg>
                                        </b>
                                    </div>
                                    <div class="col m-auto align-middle">
                                        <ul class="mb-0 ps-0 list-unstyled">
                                            <li v-if="_cds_data.cds.StudyManifesto">
                                                <a class="no-color" target="_blank" :href="_cds_data.cds.StudyManifesto">
                                                    <small><b>[[ _cds_data.cds_labels['StudyManifesto'] ]]</b></small>
                                                </a>
                                            </li>
                                            <li v-if="_cds_data.cds.DidacticRegulation">
                                                <a class="no-color" target="_blank" :href="_cds_data.cds.DidacticRegulation">
                                                    <small><b>[[ _cds_data.cds_labels['DidacticRegulation'] ]]</b></small>
                                                </a>
                                            </li>
                                            <li v-if="_cds_data.cds.TeachingSystem">
                                                <a class="no-color" target="_blank" :href="_cds_data.cds.TeachingSystem">
                                                    <small><b>[[ _cds_data.cds_labels['TeachingSystem'] ]]</b></small>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endblock %}
    </div>
</div>

<script>
var _{{ cds_cod }} = new Vue({
    el: '#_{{ cds_cod }}',
    data() {
        return {
            url: '{{ url }}?lang={{ LANGUAGE_CODE }}',
            //is_loading: true,
            loader_source: '{{ url }}',
            fields_to_show: {{ fields_to_show|safe }},
            loader_source_academicyears: '{{ academicyears_api }}?lang={{ LANGUAGE_CODE }}',
            academic_years_filter: [],
            is_loading_academicyears: true,
            regdidid: null,
            studyplans: {},
            degree_class: null,
            interclass_degree_class: null,
            academic_year: null,
            cds_cod: null,
            exclude_studyactivity_codes: {{ exclude_studyactivity_codes|safe }},
        }
    },
    mounted() {
        this.callAcademicYears()
    },
    methods: {
        callAcademicYears() {
            axios
                .get(this.loader_source_academicyears)
                .then(response => {
                    this.academic_years_filter = response.data.results
                    this.is_loading_academicyears = false
                })
        },
        callCdsByYear(year) {
            let cds_year_url = '{{ base_api }}{{ cds_api }}?lang={{ LANGUAGE_CODE }}&academicyear=' + year + '&cdscod={{ cds_identifier }}'
            axios
                .get(cds_year_url)
                .then(response => {
                    if(response.data.results.length>0 && 'RegDidId' in response.data.results[0])
                        _cds_data.CallURL(response.data.results[0]['RegDidId'])
                }
            )
        },
        changeYear(value) {
            let url = '{{ base_api }}{{ cds_websites_api }}{{ cds_identifier }}/?lang={{ LANGUAGE_CODE }}&academicyear=' + value
            axios
                .get(url)
                .then(response => {
                    this.callCdsByYear(value)
                    _{{ cds_cod }}_studyplans.callStudyPlans(value)
                }
            )
        },
    },
    //watch: {
        //regdidid: function(val) {
            //course_studyplans.regdidid = this.regdidid
        //}
    //}
})

var _cds_website_text = new Vue({
    el: '#_{{ cds_cod }}_1',
    data() {
        return {
            item: {},
        }
    },
    mounted() {
        this.callWebsite()
    },
    methods: {
        callWebsite() {
            let url = '{{ base_api }}{{ cds_websites_api }}{{ cds_cod }}/?lang={{ LANGUAGE_CODE }}'
            axios
                .get(url)
                .then(response => {
                    this.item = response.data.results
                }
            )
        },
    }
});

var _cds_website_right_col_dynamic = new Vue({
    el: '#_cds_website_right_col_dynamic',
    data() {
        return {
            item: {},
            cds: {},
        }
    },
});

var _{{ cds_cod }}_studyplans = new Vue({
    el: '#course_studyplans',
    data() {
        return {
            url: '',
            is_loading: true,
            loader_source: '',
            items: {},
            curricula: [],
        }
    },
    mounted() {
        this.callStudyPlans()
    },
    methods: {
        {% include "includes/unical_storage_cds_website_scroll.html" %}
        callStudyPlans(year={{ current_year }}) {
            this.is_loading = true
            axios
                .get('{{ base_api }}{{ cds_websites_studyplans_api }}?lang={{ LANGUAGE_CODE }}&cds_cod={{ cds_cod }}&year=' + year)
                .then(response => {
                    let curricula = []
                    if(response.data.results.length > 0) {
                        response.data.results[0].PlanTabs.forEach(
                            function (plantab) {
                                if (!curricula.includes(plantab.PdsDes)) {
                                    curricula.push(plantab.PdsDes);
                                }
                            }
                        )
                    }
                    this.curricula = curricula
                    this.items = response.data.results[0]
                    this.is_loading = false
                    this.scrollPage()
                })
        },
    },
})
</script>
{% endblock container %}
