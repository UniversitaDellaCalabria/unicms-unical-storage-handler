{% extends "pages/unical_cds_website.html" %}

{% load static %}
{% load i18n %}

{% load unicms_pages %}

{% load unicms_contexts %}
{% load unicms_storage_handler %}
{% load unicms_templates %}

{% include "includes/unical_storage_loading.html" %}


<!-- SEO  -->
{% block page_title %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_CALENDAR_LABEL" as page_title %}
{{ page_title }} - {{ block.super }}
{% endblock page_title %}


{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/unicms_storage_calendar.css' %}" type="text/css">
<!-- Link VCalendar Javascript (Plugin automatically installed) -->
<script src="https://unpkg.com/v-calendar"></script>
<style>
.calendar-hidden .vc-weeks { display: none; }
</style>
{% endblock extra_head %}


{% block container %}

<script src="{% static 'js/vue-markdown.js' %}"></script>


{% get_current_language as LANGUAGE_CODE %}
{% breadcrumbs webpath=webpath leaf=handler %}

{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_BASE_PATH" as cds_base_path %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_VIEW_PREFIX_PATH" as cds_studiare_path %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_CALENDAR_VIEW_PREFIX_PATH" as cds_studiare_calendar_path %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_SCHEDULE_VIEW_PREFIX_PATH" as cds_studiare_schedule_path %}
{% storage_settings_value "CMS_STORAGE_BASE_API" as base_api %}
{% storage_settings_value "CMS_STORAGE_CDS_API" as cds_api %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_API" as cds_websites_api %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_TOPICS_API" as topics_api %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_PAGE_TOPICS" as page_topics %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_TOPIC_ARTICLES_API" as page_topic_articles %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_LABEL" as page_title %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_CALENDAR_LABEL" as calendar_label %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_SCHEDULE_LABEL" as schedule_label %}
{% storage_settings_value "MAIN_DOMAIN" as unicms_root_url %}
{% storage_api_root "CMS_STORAGE_TEACHER_API" as teachers_api %}
{% storage_settings_value "CDS_WEBSITE_CURRENT_YEAR" as cds_website_current_year %}

{% include "includes/unical_storage_loading.html" %}


<div class="col-12 py-5 bd-content">
    <div>
        {% block centered_container %}
            <div class="container">
                <div class="row">
                    <div class="col-12 col-lg-8">

                        <p class="h1 lighter mb-4">
                            <a class="no-color" href="{{ webpath.fullpath }}{{ cds_base_path }}/{{ cds_studiare_path }}/">
                                {{ page_title }}
                            </a>
                        </p>

                        <hr class="my-4" style="color: var(--bordeaux_unical)">

                        <a class="no-color" href="{{ webpath.fullpath }}{{ cds_base_path }}/{{ cds_studiare_path }}/{{ cds_studiare_schedule_path }}/">
                            <span class="badge badge-grey-unical badge-left-text-unical square-corners my-1 me-3 ms-0 pe-5 p-2 mw-100">
                                <p class="h5">
                                    <b>{{ schedule_label }}</b>
                                </p>
                            </span>
                        </a>
                        <a class="no-color" href="{{ webpath.fullpath }}{{ cds_base_path }}/{{ cds_studiare_path }}/{{ cds_studiare_calendar_path }}/">
                            <span class="selected badge badge-grey-unical badge-left-text-unical square-corners my-1 me-3 ms-0 pe-5 p-2 mw-100">
                                <p class="h5">
                                    <b>{{ calendar_label }}</b>
                                </p>
                            </span>
                        </a>

                        <div id="impegniUP" class="mt-5">

                            <div class="mt-3">

                                <div class="card-wrapper card-space mb-3 ">
                                    <div class="card card-bg card-big no-after">
                                        <div class="card-body">
                                            <div v-if="years" class="mb-3">
                                                <select id="up_years"
                                                        name="academic_year_input"
                                                        class="form-control"
                                                         @change="resetCalendar($event.target.value)">
                                                  <option v-for="y_index in years"
                                                          :value="y_index"
                                                          :selected="year == y_index">
                                                      [[ y_index ]] {% trans "year" %}
                                                  </option>
                                                </select>
                                            </div>

                                            <div class="input-group mb-2">
                                                <label for="search_teaching"></label>
                                                <input type="text"
                                                       class="form-control"
                                                       id="search_teaching"
                                                       name="search_teaching"
                                                       placeholder="{% trans 'Teaching' %}"
                                                       v-model="search_teaching"
                                                       v-on:keyup.enter="getEvents()">

                                                <button class="btn btn-primary"
                                                        type="button"
                                                        id="search_teaching-button"
                                                        @click="getEvents()">
                                                    {% trans "Search" %}
                                                </button>
                                            </div>
                                            <div class="input-group mb-2">
                                                <label for="search_teacher"></label>
                                                <input type="text"
                                                       class="form-control"
                                                       id="search_teacher"
                                                       name="search_teacher"
                                                       placeholder="{% trans 'Teacher' %}"
                                                       v-model="search_teacher"
                                                       v-on:keyup.enter="getEvents()">

                                                <button class="btn btn-primary"
                                                        type="button"
                                                        id="search_teacher-button"
                                                        @click="getEvents()">
                                                    {% trans "Search" %}
                                                </button>
                                            </div>
                                            <div class="input-group">
                                                <label for="search_location"></label>
                                                <input type="text"
                                                       class="form-control"
                                                       id="search_location"
                                                       name="search_location"
                                                       placeholder="{% trans 'Location' %}"
                                                       v-model="search_location"
                                                       v-on:keyup.enter="getEvents()">

                                                <button class="btn btn-primary"
                                                        type="button"
                                                        id="search_location-button"
                                                        @click="getEvents()">
                                                    {% trans "Search" %}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <loading-icon
                                    v-if="is_loading_up"
                                    :loader_source="loader_source_up">
                                </loading-icon>

                                <div :style="'display: ' + css_display">
                                    <ul class="nav nav-tabs nav-tabs-icon-text" id="myTab3" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="tab1c-tab" data-bs-toggle="tab" href="#tab1b" role="tab" aria-controls="tab1b" aria-selected="true">
                                                <svg class="icon">
                                                    <use href="{% static 'svg/sprites.svg' %}#it-calendar"></use>
                                                </svg> {% trans "Calendar" %}
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="tab2b-tab" data-bs-toggle="tab" href="#tab2b" role="tab" aria-controls="tab2b" aria-selected="false">
                                                <svg class="icon">
                                                    <use href="{% static 'svg/sprites.svg' %}#it-list"></use>
                                                </svg> {% trans "List" %}
                                            </a>
                                        </li>
                                    </ul>
                                    <div class="tab-content" id="myTab3Content">
                                        <div class="tab-pane p-4 fade show active" id="tab1b" role="tabpanel" aria-labelledby="tab1c-tab">
                                            <v-calendar
                                                ref="calendar"
                                                class="custom-calendar"
                                                :masks="masks"
                                                :attributes="attributes"
                                                locale="{{ LANGUAGE_CODE }}"
                                                disable-page-swipe
                                                @update:from-page="switchPage"
                                                {% comment %}
                                                is-expanded
                                                v-if="attr.customData.dataInizio=[[ day.id ]]"
                                                :href="'http://localhost/' + attr.customData.id"
                                                {% endcomment %}>
                                                <template v-slot:day-content="{ day, attributes }">
                                                    <div class="flex flex-col h-100 overflow-hidden" style="font-size: 0.875rem">
                                                        <span class="day-label text-sm text-gray-900">[[ day.day ]]</span>
                                                        <div class="overflow-auto">
                                                                <p :key="attr.key" v-for="attr in attributes"
                                                                   class="rounded p-1 mt-0 mb-1 mx-1 text-white"
                                                                   :class="attr.customData.class"
                                                                   :style="'background: ' + attr.customData.background">
                                                                    <span style="font-size: smaller;">
                                                                        <!--[[ attr.customData.title ]]<br />-->
                                                                        <b>[[ attr.customData.title ]]</b>
                                                                        <br />
                                                                        [[ attr.customData.orarioInizio ]]/[[ attr.customData.orarioFine ]]
                                                                        <span v-if="attr.customData.docente">
                                                                            <br />
                                                                            [[ attr.customData.docente ]]
                                                                        </span>
                                                                        <span v-if="attr.customData.aula">
                                                                            <br />
                                                                            [[ attr.customData.aula ]]
                                                                        </span>
                                                                        <span v-if="attr.customData.edificio">
                                                                            <br />
                                                                            [[ attr.customData.edificio ]]
                                                                        </span>
                                                                    </span>
                                                                </p>
                                                        </div>
                                                    </div>
                                                </template>
                                            </v-calendar>
                                        </div>
                                        <div class="tab-pane p-4 fade" id="tab2b" role="tabpanel" aria-labelledby="tab2b-tab">

                                            <v-calendar
                                                ref="calendar2"
                                                class="custom-calendar calendar-hidden"
                                                :masks="masks"
                                                :attributes="attributes"
                                                locale="{{ LANGUAGE_CODE }}"
                                                disable-page-swipe
                                                @update:from-page="switchPage">
                                            </v-calendar>

                                            <div id="accordionDivEvents-lft" class="accordion accordion-left-icon" v-if="Object.keys(events).length > 0">
                                                <div class="accordion-item" v-for="(day_events, day, index) in events">
                                                    <div class="accordion-header" :id="'heading-' + index + '-lft'">
                                                        <button class="accordion-button"
                                                                type="button"
                                                                data-bs-toggle="collapse"
                                                                :data-bs-target="'#collapse-' + index +'-lft'"
                                                                aria-expanded="false"
                                                                :aria-controls="'collapse-' + index +'-lft'">
                                                            [[ new Date(day).toLocaleString("{{ LANGUAGE_CODE }}",
                                                                                            {weekday: 'long',
                                                                                             day: '2-digit',
                                                                                             month: 'long',
                                                                                             year: 'numeric'})]]
                                                        </button>
                                                    </div>
                                                    <div :id="'collapse-' + index +'-lft'"
                                                         class="accordion-collapse collapse"
                                                         data-bs-parent="#accordionDivEvents-lft"
                                                         role="region"
                                                         :aria-labelledby="'heading-' + index +'-lft'">
                                                        <div class="accordion-body">
                                                            <ul>
                                                                <li v-for="event in day_events" class="mt-3">
                                                                    <b>[[ event.insegnamento ]]</b>
                                                                    <br>
                                                                    <svg class="icon icon-xs me-2">
                                                                        <use href="{% static 'svg/sprites.svg' %}#it-clock"></use>
                                                                    </svg> [[ event.orarioInizio ]] / [[ event.orarioFine ]]
                                                                    <br>
                                                                    <span v-if="event.aula">
                                                                        <svg class="icon icon-xs me-2">
                                                                            <use href="{% static 'svg/sprites.svg' %}#it-map-marker"></use>
                                                                        </svg> [[ event.aula ]]
                                                                        <br>
                                                                    </span>
                                                                    <span v-if="event.edificio">
                                                                        <svg class="icon icon-xs me-2">
                                                                            <use href="{% static 'svg/sprites.svg' %}#it-pa"></use>
                                                                        </svg> [[ event.edificio ]]
                                                                        <br>
                                                                    </span>
                                                                    <span v-if="event.docente">
                                                                        <svg class="icon icon-xs me-2">
                                                                            <use href="{% static 'svg/sprites.svg' %}#it-user"></use>
                                                                        </svg> [[ event.docente ]]
                                                                    </span>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-else>
                                                {% trans "No items here" %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- END Orario lezioni -->
                    </div>
                    <div class="col-12 col-lg-3 offset-lg-1">
                        {% include "includes/unical_storage_cds_website_right_static.html" %}
                        <hr style="color: transparent" class="my-3" />
                        {% include "includes/unical_storage_cds_website_right_contacts.html" %}
                    </div>
                </div>
            </div>
        {% endblock %}
    </div>
</div>

<script>
    Vue.use(VueMarkdown);

    var _{{ cds_cod }} = new Vue({
        el: '#impegniUP',
        data () {
            return {
                events: {},
                years: [],
                year: 1,
                is_loading_up: true,
                loader_source_up: '',
                attributes: [],
                regdidid: null,
                url: '',
                masks: {weekdays: 'WWW',},
                css_display: 'none',
                search_teaching: '',
                search_teacher: '',
                search_location: ''
            } //end return
        }, //end data
        mounted()  {
            //this.getEvents();
        },
        methods: {
            {% include "includes/unical_storage_cds_website_scroll.html" %}
            getEvents(date_month={% now "m" %}, date_year={% now "Y" %}, year=1) {

                if(this.$refs.calendar!='undefined')
                    this.$refs.calendar.move({ month: date_month,
                                               year: date_year })
                if(this.$refs.calendar2!='undefined')
                    this.$refs.calendar2.move({ month: date_month,
                                                year: date_year })

                this.attributes = []
                this.events = {}
                let up_url = '{{ base_api }}{{ cds_websites_api }}{{ cds_cod }}/exams/?lang={{ LANGUAGE_CODE }}&academic_year={{ cds_website_current_year }}&year=' + year + '&date_year=' + date_year +'&date_month=' + date_month + '&search_teaching=' + this.search_teaching + '&search_teacher=' + this.search_teacher + '&search_location=' + this.search_location
                this.year = year
                this.is_loading_up = true
                this.css_display = 'none'
                axios
                    .get(up_url)
                    .then(response => {
                        //this.events = response.data
                        this.is_loading_up = false
                        this.css_display = 'block'

                        response.data.forEach((item, index)=>{
                            if(!(item.dataInizio in this.events)){
                                this.events[item.dataInizio] = []
                            }
                            this.events[item.dataInizio].push(item)

                            this.attributes.push(
                                {
                                    key: index,
                                    customData: {
                                        class: 'bg-secondary text-white',
                                        title: item.insegnamento,
                                        dataInizio: item.dataInizio,
                                        dataFine: item.dataFine,
                                        orarioInizio: item.orarioInizio,
                                        orarioFine: item.orarioFine,
                                        docente: item.docente,
                                        aula: item.aula,
                                        edificio: item.edificio,
                                    },
                                    dates: { start: new Date(item.dataInizio),
                                             end: new Date(item.dataFine) }
                                }
                            )
                        })
                        this.scrollPage()
                    }
                )
            },
            switchPage(page) {
                // if there is a real page switch
                if(!page.hasOwnProperty('date'))
                    this.getEvents(date_month=page.month, date_year=page.year, year=this.year)
            },
            resetCalendar(year) {
                this.getEvents(date_month={% now "m" %}, date_year={% now "Y" %}, year)
            },
        }, //methods
        watch: {
            regdidid: function(val) {
                let year_index = 1

                while(year_index <= _cds_data.cds.CdSDuration) {
                    this.years.push(year_index)
                    year_index += 1
                }

                this.getEvents()
            }
        }
    }) //end "new Vue"
</script>
{% endblock container %}
