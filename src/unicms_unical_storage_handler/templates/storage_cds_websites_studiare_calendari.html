{% extends "pages/unical_cds_website.html" %}

{% load static %}
{% load i18n %}

{% load unicms_pages %}

{% load unicms_contexts %}
{% load unicms_storage_handler %}
{% load unicms_templates %}

{% include "includes/unical_storage_loading.html" %}


<!-- SEO  -->
{% block page_title %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_CALENDAR_LABEL" as page_title %}
{{ page_title }} - {{ block.super }}
{% endblock page_title %}


{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/unicms_storage_calendar.css' %}" type="text/css">
<!-- Link VCalendar Javascript (Plugin automatically installed) -->
<script src="https://unpkg.com/v-calendar"></script>
<style>
.calendar-hidden .vc-weeks { display: none; }
</style>
{% endblock extra_head %}


{% block container %}

<script src="{% static 'js/vue-markdown.js' %}"></script>


{% get_current_language as LANGUAGE_CODE %}
{% breadcrumbs webpath=webpath leaf=handler %}

{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_BASE_PATH" as cds_base_path %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_VIEW_PREFIX_PATH" as cds_studiare_path %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_CALENDAR_VIEW_PREFIX_PATH" as cds_studiare_calendar_path %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_SCHEDULE_VIEW_PREFIX_PATH" as cds_studiare_schedule_path %}
{% storage_settings_value "CMS_STORAGE_BASE_API" as base_api %}
{% storage_settings_value "CMS_STORAGE_CDS_API" as cds_api %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_API" as cds_websites_api %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_TOPICS_API" as topics_api %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_PAGE_TOPICS" as page_topics %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_TOPIC_ARTICLES_API" as page_topic_articles %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_LABEL" as page_title %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_CALENDAR_LABEL" as calendar_label %}
{% storage_settings_value "CMS_STORAGE_CDS_WEBSITES_STUDIARE_SCHEDULE_LABEL" as schedule_label %}
{% storage_settings_value "MAIN_DOMAIN" as unicms_root_url %}
{% storage_api_root "CMS_STORAGE_TEACHER_API" as teachers_api %}
{% storage_settings_value "CDS_WEBSITE_CURRENT_YEAR" as cds_website_current_year %}

{% include "includes/unical_storage_loading.html" %}


<div class="col-12 py-5 bd-content">
    <div>
        {% block centered_container %}
            <div class="container">
                <div class="row">
                    <div class="col-12 col-lg-8">

                        <p class="h1 lighter mb-4">
                            <a class="no-color" href="{{ webpath.fullpath }}{{ cds_base_path }}/{{ cds_studiare_path }}/">
                                {{ page_title }}
                            </a>
                        </p>

                        <hr class="my-4" style="color: var(--bordeaux_unical)">

                        <a class="no-color" href="{{ webpath.fullpath }}{{ cds_base_path }}/{{ cds_studiare_path }}/{{ cds_studiare_schedule_path }}/">
                            <span class="badge badge-grey-unical badge-left-text-unical square-corners my-1 me-3 ms-0 pe-5 p-2 mw-100">
                                <p class="h5">
                                    <b>{{ schedule_label }}</b>
                                </p>
                            </span>
                        </a>
                        <a class="no-color" href="{{ webpath.fullpath }}{{ cds_base_path }}/{{ cds_studiare_path }}/{{ cds_studiare_calendar_path }}/">
                            <span class="selected badge badge-grey-unical badge-left-text-unical square-corners my-1 me-3 ms-0 pe-5 p-2 mw-100">
                                <p class="h5">
                                    <b>{{ calendar_label }}</b>
                                </p>
                            </span>
                        </a>

                        <div id="impegniUP" class="mt-5">
                            <div class="mt-3">
                                <div class="card-wrapper card-space mb-3">
                                    <div class="card card-bg card-big no-after">
                                        <div class="card-body">
                                            <div v-if="years">
                                                <select id="up_years"
                                                        name="academic_year_input"
                                                        class="form-control"
                                                        @change="changeYear($event.target.value)">
                                                  <option v-for="y_index in years"
                                                          :value="y_index"
                                                          :selected="year == y_index">
                                                      [[ y_index ]] {% trans "year" %}
                                                  </option>
                                                </select>
                                            </div>
                                            <div v-if="studyplans.length > 1" class="mt-3">
                                                <select id="up_af"
                                                        name="teaching_input"
                                                        class="form-control"
                                                        @change="choseAF($event.target.value)">
                                                  <option value="">-</option>
                                                  <optgroup :label="[[ studyplan.StudyPlanName ]]" v-for="studyplan in studyplans">
                                                    <option v-for="teaching in studyplan.StudyActivities[year]" :value="teaching.StudyActivityCod + '-' + teaching.StudyActivityName">
                                                        [[ teaching.StudyActivityCod ]] - [[ teaching.StudyActivityName ]]
                                                    </option>
                                                  </optgroup>
                                                </select>
                                            </div>
                                            <div v-else-if="studyplans.length == 1" class="mt-3">
                                                <select id="up_af"
                                                        name="teaching_input"
                                                        class="form-control"
                                                        @change="choseAF($event.target.value)">
                                                  <option value="">-</option>
                                                  <option v-if="studyplans.length > 0" v-for="teaching in studyplans[0].StudyActivities[year]" :value="teaching.StudyActivityCod + '-' + teaching.StudyActivityName">
                                                        [[ teaching.StudyActivityCod ]] - [[ teaching.StudyActivityName ]]
                                                  </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <loading-icon
                                    v-if="is_loading && chosen_af_cod != ''"
                                    :loader_source="loader_source">
                                </loading-icon>

                                <div class="table-responsive" v-else-if="chosen_af_cod != ''">
                                    <table class="table table-hover table-striped">
                                        <tr v-for="event in events">
                                            <td class="p-3">
                                                <b>
                                                    [[ new Date(event.dataInizio).toLocaleString("{{ LANGUAGE_CODE }}",
                                                                                        {weekday: 'long',
                                                                                         day: '2-digit',
                                                                                         month: 'long',
                                                                                         year: 'numeric'})]]
                                                </b>
                                                <span class="badge bg-success" v-if="event.codice=='ESSE3_ES'">Confermato</span>
                                                <span class="badge bg-warning" v-else>Da confermare</span>
                                                <br>
                                                <svg class="icon icon-xs me-2">
                                                    <use href="{% static 'svg/sprites.svg' %}#it-clock"></use>
                                                </svg> [[ event.orarioInizio ]] <span v-if="event.orarioFine">/ [[ event.orarioFine ]]</span>
                                                <br>
                                                <span v-if="event.aula">
                                                    <svg class="icon icon-xs me-2">
                                                        <use href="{% static 'svg/sprites.svg' %}#it-map-marker"></use>
                                                    </svg> [[ event.aula ]]
                                                    <br>
                                                </span>
                                                <span v-if="event.edificio">
                                                    <svg class="icon icon-xs me-2">
                                                        <use href="{% static 'svg/sprites.svg' %}#it-pa"></use>
                                                    </svg> [[ event.edificio ]]
                                                    <br>
                                                </span>
                                                <span v-if="event.docente">
                                                    <svg class="icon icon-xs me-2">
                                                        <use href="{% static 'svg/sprites.svg' %}#it-user"></use>
                                                    </svg> [[ event.docente ]]
                                                </span>
                                                <span v-if="event.extra.dataInizioIscrizioni">
                                                    <svg class="icon icon-xs me-2">
                                                        <use href="{% static 'svg/sprites.svg' %}#it-list"></use>
                                                    </svg>
                                                    {% trans "Prenotazioni" %}
                                                    {% trans "dal" %} [[ event.extra.dataInizioIscrizioni ]]
                                                    <span v-if="event.extra.dataFineIscrizioni">
                                                        {% trans "al" %} [[ event.extra.dataFineIscrizioni ]]
                                                    </span>
                                                </span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- END Orario lezioni -->
                    </div>
                    <div class="col-12 col-lg-3 offset-lg-1">
                        {% include "includes/unical_storage_cds_website_right_static.html" %}
                        <hr style="color: transparent" class="my-3" />
                        {% include "includes/unical_storage_cds_website_right_contacts.html" %}
                    </div>
                </div>
            </div>
        {% endblock %}
    </div>
</div>

<script>
    Vue.use(VueMarkdown);

    var _{{ cds_cod }} = new Vue({
        el: '#impegniUP',
        data () {
            return {
                events: [],
                years: [],
                year: 1,
                is_loading: true,
                loader_source: '',
                regdidid: null,
                url: '',
                studyplans: [],
                chosen_af_name: '',
                chosen_af_cod: ''
            } //end return
        }, //end data
        mounted()  {},
        methods: {
            {% include "includes/unical_storage_cds_website_scroll.html" %}
            getEvents() {
                this.events = []
                let up_url = '{{ base_api }}{{ cds_websites_api }}{{ cds_cod }}/exams/?lang={{ LANGUAGE_CODE }}&academic_year={{ cds_website_current_year }}&year=' + this.year + '&af_name=' + this.chosen_af_name + '&af_cod=' + this.chosen_af_cod
                axios
                    .get(up_url)
                    .then(response => {
                        this.events = response.data
                        this.is_loading = false
                    })
            },
            callStudyPlans(regdid=null) {
                if(!regdid) regdid = this.regdidid
                let teachings_url = "{{ base_api }}{{ cds_api }}" + regdid + "/studyplans/"
                axios
                    .get(teachings_url)
                    .then(response => {
                        this.studyplans = response.data.results
                    })
            },
            choseAF(af_string){
                let af_array = af_string.split("-")
                this.chosen_af_cod = af_array[0]
                this.chosen_af_name = af_array[1]
            },
            changeYear(year){
                this.year = year
                this.chosen_af_cod = ''
                this.chosen_af_bane = ''
                let ac_year = _cds_data.cds.AcademicYear - year + 1
                let url = '{{ base_api }}{{ cds_api }}?lang={{ LANGUAGE_CODE }}&cdscod={{ cds_cod }}&academicyear=' + ac_year
                axios
                    .get(url)
                    .then(response => {
                        this.studyplans = []
                        if(response.data.results && response.data.results.length > 0){
                            this.callStudyPlans(response.data.results[0].RegDidId)
                        }
                    })
            }
        },
        watch: {
            regdidid: function(val) {
                let year_index = 1
                while(year_index <= _cds_data.cds.CdSDuration) {
                    this.years.push(year_index)
                    year_index += 1
                }
                this.callStudyPlans()
            },
            chosen_af_cod: function(val) {
                if(val != '') this.getEvents()
                else this.events = []
                this.is_loading = true
            },
        }
    }) //end "new Vue"
</script>
{% endblock container %}
